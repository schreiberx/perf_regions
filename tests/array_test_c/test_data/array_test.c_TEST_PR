#include <stdio.h>
#include <stdlib.h>

//PERF_REGION_ORIGINAL
//#pragma perf_regions include
//PERF_REGION_CODE
#include <perf_regions.h>

double *a;
int size;

void run_computations()
{
	for (long long i = 0; i < size; i++)
		a[i] += a[i] * a[i];
}

int main(int i_argi, char **argv)
{
	for (size = 1; size < 1024 * 1024 * 128 / 8; size *= 2)
	{
		a = malloc(sizeof(double) * size);
		int iters = (1024 * 128) / size;
		iters = (iters <= 0 ? 2 : iters);
		iters = (iters > 128 ? 128 : iters);

//PERF_REGION_ORIGINAL
//#pragma perf_regions init
//PERF_REGION_CODE
perf_regions_init();
//PERF_REGION_ORIGINAL
//#pragma perf_regions start outer
//PERF_REGION_CODE
perf_region_start(0, "outer");

		printf("\n");
		printf("**************************************\n");
		printf("Mem size: %f KByte\n", (double)size * 0.001);
		printf("Iterations: %i\n", iters);

		// initialize everything
		for (int i = 0; i < size; i++)
			a[i] = i;

		// dummy computations to warmup caches
		run_computations();
		for (int k = 0; k < iters; k++)
		{

//PERF_REGION_ORIGINAL
//#pragma perf_regions start foo
//PERF_REGION_CODE
perf_region_start(1, "foo");

			run_computations();
//PERF_REGION_ORIGINAL
//#pragma perf_regions stop foo
//PERF_REGION_CODE
perf_region_stop(1);   // name="foo"

//PERF_REGION_ORIGINAL
//#pragma perf_regions start bar
//PERF_REGION_CODE
perf_region_start(2, "bar");
			run_computations();
			run_computations();
//PERF_REGION_ORIGINAL
//#pragma perf_regions stop bar
//PERF_REGION_CODE
perf_region_stop(2);   // name="bar"

			//			perf_region_set_normalize(PERF_REGIONS_FOO, fac);
		}

//PERF_REGION_ORIGINAL
//#pragma perf_regions stop outer
//PERF_REGION_CODE
perf_region_stop(0);   // name="outer"
//PERF_REGION_ORIGINAL
//#pragma perf_regions finalize
//PERF_REGION_CODE
perf_regions_finalize();

		free(a);
	}
	return 0;
}

